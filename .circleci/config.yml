version: 2

jobs:
  build:
    machine: # executor type
      image: ubuntu-2004:2022.07.1
    steps:
      - checkout
      - run:
          name: node install
          command: sudo curl -sL https://deb.nodesource.com/setup_18.x -o nodesource_setup.sh
      - run:
          name: Install Node
          command: sudo apt install nodejs
      - run:
          name: Install NPM
          command: sudo apt install npm
      - run:
          name: Install Dependencies
          command: npm install
      - run:
          name: Run Tests
          command: npm test
  deploy:
    docker:
      - image: cimg/node:lts
        auth:
          username: rootx98
          password: BEm9ujb4Xn5WUmD  # context / project UI env-var reference
    steps:
      - checkout
      - run:
          name: Deploy Main to Heroku
          command: |
            git branch master
            git push https://heroku:59f76567-d0d5-4033-9175-ef20b931f3bf@git.heroku.com/full-stack-backend.git master
      - run: npm start

workflows:
  version: 2
  build-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: main
